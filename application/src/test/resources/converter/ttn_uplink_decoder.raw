/**
 * Decodes the incoming payload and returns a structured object containing telemetry data and attributes.
 *
 * @param {byte[]} input - The raw payload received as an array of bytes.
 * @returns {Object} output - The structured output with decoded telemetry and attributes.
 */

function decodePayload(input) {
    // Initialize the output object with empty attributes and telemetry for clarity.
    var result = { attributes: {}, telemetry: {}};

    // Parse timestamp from the selected date string (returns current time if invalid).
    var timestamp = parseDateToTimestampOrNow(extractDateFromMetadata()); // Extract the date string from metadata using extractDateFromMetadata() function.

    // Initialize an object to store decoded key/value telemetry data.
    var values = {};

    // Decode battery level from the 5th byte of the payload.
    values.battery = parseBytesToInt(input, 4, 1);

    // Decode temperature from the 6th and 7th bytes of the payload (divided by 100).
    values.temperature = parseBytesToInt(input, 5, 2) / 100.0;

    // Combine the timestamp with values and add it to the telemetry.
    result.telemetry = {
        ts: timestamp,
        values: values
    };

    // Return the fully constructed output object.
    return result;
}

var result = decodePayload(payload);
result.profile = 'IndustrialSensorProfile'; // Device or asset profile name.
result.customer = 'MyCustomer'; // If customer is not null - created entity will be assigned to customer with such name.
result.group = 'SensorsGroup'; // If group is not null - created entity will be added to the entity group with such name.

// Return the final result object.
return result;

function extractDateFromMetadata() {
  var date = metadata.uplinkMessageReceivedAt; // uplinkMessageReceivedAt from the incoming message.
  if ((metadata.simulated != null && metadata.simulated) || date == null) {
      date = metadata.receivedAt; // receivedAt from the incoming message.
  }

  return date;
}
