var data = decodeToJson(payload);
var deviceName = data.deviceInfo.deviceName + " " + data.deviceInfo.devEui;
var deviceType = data.deviceInfo.deviceProfileName;
var groupName = null; // If groupName is not null - created device will be added to the entity group with such name.
var customerName = null; // If customerName is not null - created devices will be assigned to customer with such name.

// use assetName and assetType instead of deviceName and deviceType
// to automatically create assets instead of devices.
// var assetName = 'Asset A';
// var assetType = 'building';

// If you want to parse incoming data somehow, you can add your code to this function.
// input: bytes
// Note ts represents a timestamp in milliseconds since the Unix epoch (January 1, 1970)
// expected output:
//  {
//    "attributes": {"attributeKey": "attributeValue"},
//    "telemetry": [{"ts": 1730898982391, "values": {"telemetryKey":"telemetryValue"}, {"ts": 1730518182391, "values": {"telemetryKey":"telemetryValue"}}]
//  }

function decodePayload(input) {
    var output = {
        attributes: {},
        telemetry: []
    };

    // --- Decoding code --- //
    var decoded = {};

    output.telemetry = [{
        ts: timestamp,
        values: decoded
    }];
    // --- Decoding code --- //
    return output;
}

// --- attributes and telemetry objects ---
var telemetry = [];
var attributes = {};
// --- attributes and telemetry objects ---

// --- Timestamp parsing
var dateString = data.time;
timestamp = parseDateToTimestamp(dateString);
// --- Timestamp parsing

// Passing incoming bytes to decodePayload function, to get custom decoding
var customDecoding = decodePayload(base64ToBytes(data
.data));

// Collecting data to result
if (customDecoding.?telemetry.size() > 0) {
    foreach(telemetryObj: customDecoding.telemetry) {
        if (telemetryObj.ts != null && telemetryObj.values != null) {
            telemetry.add(telemetryObj);
        }
    }
}

if (customDecoding.?attributes.size() > 0) {
    attributes.putAll(customDecoding.attributes);
}

// You can add some keys manually to attributes or telemetry
attributes.eui = data.deviceInfo.?devEui;
attributes.devAddr = data.devAddr;
attributes.fPort = data.fPort;

// Uncomment to add more attributes;
//attributes.applicationId = data.deviceInfo.?applicationId;
//attributes.applicationName = data.deviceInfo.?applicationName;
//attributes.tenantId = data.deviceInfo.?tenantId;
//attributes.tenantName = data.deviceInfo.?tenantName;
//attributes.deviceProfileId = data.deviceInfo.?deviceProfileId;
//attributes.deviceProfileName = data.deviceInfo.?deviceProfileName;
//attributes.frequency = data.txInfo.?frequency;
//attributes.bandwidth = data.txInfo.?modulation.?lora.?bandwidth;
//attributes.spreadingFactor = data.txInfo.?modulation.?lora.?spreadingFactor;
//attributes.codeRate = data.txInfo.?modulation.?lora.?codeRate;

// includeGatewayInfo is set to false by default in the metadata, but you can change this value if needed
if(Boolean.parseBoolean(metadata["includeGatewayInfo"])) {
   var gatewayInfo = getGatewayInfo();
   var addDataToTelemetry = {};

   // You can add some keys manually to telemetry
   addDataToTelemetry.snr = gatewayInfo.snr;
   addDataToTelemetry.rssi = gatewayInfo.rssi;
   addDataToTelemetry.channel = gatewayInfo.channel;
   addDataToTelemetry.rfChain = gatewayInfo.rfChain;
   addDataToTelemetry.fCnt = data.fCnt;
   // You can add some keys manually to telemetry

   telemetry = processTelemetryData(telemetry, addDataToTelemetry);
}

var result = {
    deviceName: deviceName,
    deviceType: deviceType,
    //  assetName: assetName,
    //  assetType: assetType,
    attributes: attributes,
    telemetry: telemetry
};

addAdditionalInfoForDeviceMsg(result, customerName, groupName);

return result;

function addAdditionalInfoForDeviceMsg(deviceInfo, customerName, groupName) {
    if (customerName != null) {
        deviceInfo.customerName = customerName;
    }
    if (groupName != null) {
        deviceInfo.groupName = groupName;
    }
}

function parseDateToTimestamp(dateString) {
    var date = new Date(dateString);
    var timestamp = date.getTime();

    // If we cannot parse timestamp - we will use the current timestamp
    if (timestamp == -1) {
        timestamp = Date.now();
    }

    return timestamp;
}

function getGatewayInfo() {
    var gatewayList = data.rxInfo;
    var maxRssi = Integer.MIN_VALUE;
    var gatewayInfo = {};

    foreach (gateway : gatewayList) {
        if(gateway.rssi > maxRssi) {
            maxRssi = gateway.rssi;
            gatewayInfo = gateway;
        }
    }

    return gatewayInfo;
}

function processTelemetryData(telemetry, addDataToTelemetry) {
    if (telemetry.size >= 1) {
        telemetry = addDataToTelemetries(telemetry, addDataToTelemetry);
    }
    else {
        telemetry.add(addDataToTelemetry);
    }

    return telemetry;
}

function addDataToTelemetries(telemetries, addDataToTelemetry) {
    foreach(telemetry : telemetries) {
        foreach(element : addDataToTelemetry.entrySet()) {
            if(!telemetry["values"].keys.contains(element.key)) {
                telemetry["values"][element.key] = element.value;
            }
        }
    }

    return telemetries;
}
